- name: enable EPEL repo
  sudo: yes
  yum:
    name: epel-release
    state: latest
  tags:
    - monitoring

- name: install pip
  sudo: yes
  yum:
    name: python-pip
    state: latest
  tags:
    - monitoring

- name: install docker python module
  sudo: yes
  yum:
    name: docker-python
    state: latest
  tags:
    - monitoring

- name: update setuptools and pip
  sudo: yes
  pip:
    name: "{{ item.name }}"
    state: latest
  with_items:
    - name: pip
    - name: setuptools
  tags:
    - monitoring

- name: install collectd
  sudo: yes
  yum:
    name: collectd
    state: latest
  tags:
    - monitoring


- name: deploy collectd daemon configuration
  sudo: yes
  template:
    src: collectd.conf.j2
    dest: /etc/collectd.conf
  tags:
    - monitoring

- name: deploy collectd network plugin configuration
  sudo: yes
  template:
    src: write_network.conf.j2
    dest: /etc/collectd.d/write_network.conf
  tags:
    - monitoring

- name: create collectd docker plugin directory
  sudo: yes
  file:
    path: /usr/share/collectd/plugins
    state: directory
    mode: 0770
  tags:
  - monitoring

- name: deploy collectd python plugins configuration
  sudo: yes
  template:
    src: python-plugins.conf.j2
    dest: /etc/collectd.d/python-plugins.conf
  tags:
    - monitoring

- name: deploy collectd docker plugin files
  sudo: yes
  copy:
    src: "roles/monitoring/files/{{ item.src }}"
    dest: "/usr/share/collectd/plugins/{{ item.src }}"
    mode: u=r
  with_items:
    - src: docker-plugin-requirements.txt
    - src: dockerplugin.py
    - src: dockerplugin.db
    - src: mesos-master.py
    - src: mesos-slave.py
  tags:
    - monitoring

- name: install docker plugin requirements
  sudo: yes
  pip:
    requirements: "/usr/share/collectd/plugins/docker-plugin-requirements.txt"
  notify:
    - restart collectd
  tags:
    - monitoring


