---
# Include mesos vars so that we can access the zk information in the json file
- include_vars: "{{ playbook_dir }}/../roles/mesos/defaults/main.yml"

- name: create json files for jobs
  sudo: yes
  run_once: true
  template:
    src: "{{ item }}.json.j2"
    dest: "/etc/marathon/apps/{{ item }}.json"
  with_items:
    - elasticsearch
    - kibana
  tags:
    - elk

- name: install mesos elasticsearch framework, kibana container
  run_once: true
  sudo: yes
  command: >
    curl -X PUT -H "Content-Type: application/json"
    -d@"/etc/marathon/apps/{{ item }}.json"
    "http://localhost:18080/v2/apps/{{ item }}"
  changed_when: false
  failed_when: "'deploymentId' not in result.stdout"
  register: result
  with_items:
    - elasticsearch
    - kibana
  tags:
    - elk

- include: kibana.yml
  when: "'role=worker' in group_names"
